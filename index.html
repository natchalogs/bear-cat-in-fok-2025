<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bear Cat In FOK 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        /* (CSS Styles remain the same) */
        details[open] summary {
            font-weight: 600;
        }
        .timeline-item {
            position: relative;
            padding-left: 1.5rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.25rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
        }
        .timeline-item:first-child::before {
            top: 0.5rem;
        }
        .timeline-item:last-child::before {
            bottom: 0.5rem;
        }
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 0.625rem;
            height: 0.625rem;
            background-color: #3b82f6;
            border-radius: 9999px;
            border: 2px solid white;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            onSnapshot,
            updateDoc,
            getDoc,
            arrayUnion,
            arrayRemove,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        let app, db, auth;
        let userId, userDisplayName;
        const tripDocId = "mhee-maew-trip-2025"; 
        let appData = null; 
        let unsubscribeTrip = null; 
        
        // GLOBAL EDITING STATE (To prevent re-renders from closing edit forms)
        let editingState = {
            checklist: null, // stores ID of item being edited
            expenses: null,  // stores ID of item being edited
            poi: null        // stores ID of item being edited
        };

        // -----------------------------------------------------------------
        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyDzYQTm0V6yBcOCyBGJxD65AoGRHKEOZng",
          authDomain: "bear-cat-in-fok-2025.firebaseapp.com",
          projectId: "bear-cat-in-fok-2025",
          storageBucket: "bear-cat-in-fok-2025.firebasestorage.app",
          messagingSenderId: "178010604106",
          appId: "1:178010604106:web:2dc3d30600b7a8d7769cb3",
          measurementId: "G-KDSLTNV0MJ"
        };
        // -----------------------------------------------------------------

        // (Tailwind Config remains the same)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans Thai', 'sans-serif'],
                    },
                },
            },
        };

        // (displayError function remains the same)
        function displayError(message, error) {
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElement.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${message}. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${error?.message || error}`;
                errorElement.classList.remove('hidden');
            }
            console.error(message, error);
        }

        // --- Firebase Initialization and Auth ---
        async function initFirebaseAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                // MODIFIED AUTH LOGIC
                onAuthStateChanged(auth, async (user) => {
                    const loadingScreen = document.getElementById('loading-screen');
                    const mainApp = document.getElementById('main-app');
                    const loginScreen = document.getElementById('login-screen');
                    const userDisplay = document.getElementById('user-display');
                    const logoutButton = document.getElementById('logout-button');

                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        userDisplayName = user.displayName || user.email;

                        mainApp.classList.remove('hidden');
                        loginScreen.classList.add('hidden');
                        // Shorten name for display
                        const shortName = userDisplayName.split(' ')[0];
                        userDisplay.textContent = shortName;
                        logoutButton.classList.remove('hidden');

                        await loadDataAndRender();
                    } else {
                        // User is signed out
                        userId = null;
                        userDisplayName = null;
                        if (unsubscribeTrip) unsubscribeTrip(); 

                        mainApp.classList.add('hidden');
                        loginScreen.classList.remove('hidden');
                        userDisplay.textContent = '';
                        logoutButton.classList.add('hidden');
                    }
                    
                    // Hide loading screen *after* deciding which screen to show
                    loadingScreen.classList.add('hidden');
                });
            } catch (error) {
                displayError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ‡πÑ‡∏î‡πâ", error);
            }
        }
        
        // (Google Login/Logout Functions remain the same)
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                displayError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Google ‡πÑ‡∏î‡πâ", error);
            }
        }

        async function signOutApp() {
            try {
                await signOut(auth);
            } catch (error) {
                displayError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡πÑ‡∏î‡πâ", error);
            }
        }

        // (loadDataAndRender remains the same)
        async function loadDataAndRender() {
            if (!db || !tripDocId) return;
            const docRef = doc(db, "tripPlans", tripDocId);

            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    await initializeDocument(docRef);
                }

                if (unsubscribeTrip) unsubscribeTrip();
                unsubscribeTrip = onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        appData = doc.data();
                        renderUI(appData);
                    } else {
                        displayError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", "Document does not exist");
                    }
                }, (error) => {
                    displayError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (onSnapshot)", error);
                });
            } catch (error) {
                displayError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", error);
            }
        }

        async function initializeDocument(docRef) {
            const initialData = {
                flightInfo: [
                    {
                        title: "‡∏Ç‡∏≤‡πÑ‡∏õ (BKK ‚Üí FUK)",
                        flights: [
                            "26 ‡∏ï.‡∏Ñ. 2568, 23:50 (BKK) ‚Üí 27 ‡∏ï.‡∏Ñ. 04:50 (MNL) | PR733 | ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á 52J, 52K",
                            "27 ‡∏ï.‡∏Ñ. 2568, 10:00 (MNL) ‚Üí 14:40 (FUK) | PR426 | ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á 51A, 51B"
                        ]
                    },
                    {
                        title: "‡∏Ç‡∏≤‡∏Å‡∏•‡∏±‡∏ö (KIX ‚Üí DMK)",
                        flights: [
                            "3 ‡∏°‡∏µ.‡∏Ñ. 2569, 09:55 (KIX) ‚Üí 14:25 (DMK) | XJ613 | ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á 42F, 42G"
                        ]
                    }
                ],
                accommodations: [
                    {
                        name: "ÊóßP203 Phoenix inn (Fukuoka)",
                        dates: "27 ‡∏ò.‡∏Ñ. - 30 ‡∏ò.‡∏Ñ.",
                        address: "5-ch≈çme-4-15 Katakasu, Hakata Ward",
                        mapLink: "https://www.google.com/maps/place/5-ch%C5%8Dme-4-15+Katakasu,+Hakata+Ward,+Fukuoka,+812-0043,+Japan", 
                        priceTHB: 4553.31,
                        station: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ Hakata (‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 5-10 ‡∏ô‡∏≤‡∏ó‡∏µ)"
                    },
                    {
                        name: "Â§©ÁéãÂØ∫204 (Osaka)",
                        dates: "30 ‡∏ò.‡∏Ñ. - 3 ‡∏°.‡∏Ñ.",
                        address: "ÂçóÊ≤≥Â†ÄÁî∫10-3, Â§ßÈò™Â∏ÇÂ§©ÁéãÂØ∫Âå∫",
                        mapLink: "https://www.google.com/maps/place/10-3+Minamikawahorich%C5%8D,+Tenn%C5%8Dji+Ward,+Osaka,+543-0054,+Japan", 
                        priceTHB: 5190.00,
                        station: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ JR Tennoji (‡πÄ‡∏î‡∏¥‡∏ô 3 ‡∏ô‡∏≤‡∏ó‡∏µ)"
                    }
                ],
                dailyItinerary: [
                    { day: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 (27 ‡∏ò.‡∏Ñ.): Fukuoka", items: [{ id: `item${Date.now()}`, time: "15:00", text: "Check-in ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (Phoenix inn)", createdBy: "System"}] },
                    { day: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2 (28 ‡∏ò.‡∏Ñ.): Fukuoka", items: [] },
                    { day: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3 (29 ‡∏ò.‡∏Ñ.): Fukuoka", items: [] },
                    { day: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 4 (30 ‡∏ò.‡∏Ñ.): Travel to Osaka", items: [{ id: `item${Date.now()+1}`, time: "15:00", text: "Check-in ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (Tennoji 204)", createdBy: "System"}] },
                    { day: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 (31 ‡∏ò.‡∏Ñ.): Osaka", items: [] },
                    { day: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 6 (1 ‡∏°.‡∏Ñ.): Osaka/Kyoto", items: [] },
                    { day: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7 (2 ‡∏°.‡∏Ñ.): Osaka", items: [] },
                    { day: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 8 (3 ‡∏°.‡∏Ñ.): Travel Back", items: [] }
                ],
                expenses: [
                    { id: "exp1", name: "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å Fukuoka (Airbnb)", amount: 4553.31, currency: "THB", createdBy: "System" },
                    { id: "exp2", name: "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å Osaka (Airbnb)", amount: 5190.00, currency: "THB", createdBy: "System" },
                    { id: "exp3", name: "‡∏Ñ‡πà‡∏≤‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á XJ613 (2 ‡∏Ñ‡∏ô)", amount: 1240.00, currency: "THB", createdBy: "System" }
                ],
                checklist: [
                    { id: "chk1", name: "‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å Fukuoka", done: true, createdBy: "System" },
                    { id: "chk2", name: "‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å Osaka", done: true, createdBy: "System" },
                    { id: "chk3", name: "‡∏à‡∏≠‡∏á‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô", done: true, createdBy: "System" },
                    { id: "chk4", name: "‡∏à‡∏≠‡∏á JR Pass", done: false, createdBy: "System" },
                    { id: "chk5", name: "‡πÅ‡∏•‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏¢‡∏ô", done: false, createdBy: "System" }
                ],
                poiCatalog: [] // EMPTY POI CATALOG AS REQUESTED
            };
            await setDoc(docRef, initialData);
        }
        
        // --- Main UI Rendering Functions ---
        
        function renderUI(data) {
            if (!data) return;
            const safeData = {
                dailyItinerary: data.dailyItinerary || [],
                checklist: data.checklist || [],
                expenses: data.expenses || [],
                poiCatalog: data.poiCatalog || [],
                flightInfo: data.flightInfo || [],
                accommodations: data.accommodations || []
            };
            try { renderDailyItinerary(safeData.dailyItinerary, safeData.poiCatalog); } catch (e) { displayError("Error in renderDailyItinerary", e); }
            try { renderChecklist(safeData.checklist); } catch (e) { displayError("Error in renderChecklist", e); }
            try { renderExpenses(safeData.expenses); } catch (e) { displayError("Error in renderExpenses", e); }
            try { renderPOI(safeData.poiCatalog); } catch (e) { displayError("Error in renderPOI", e); }
            try { renderFlights(safeData.flightInfo); } catch (e) { displayError("Error in renderFlights", e); }
            try { renderAccommodations(safeData.accommodations); } catch (e) { displayError("Error in renderAccommodations", e); }
        }

        // (renderFlights & renderAccommodations remain the same)
        function renderFlights(flightInfo) {
            const container = document.getElementById('flight-info-container');
            if (!container) return;
            container.innerHTML = flightInfo.map(info => `
                <div class="mb-4">
                    <h4 class="font-semibold text-lg text-gray-800">${info.title}</h4>
                    <ul class="list-disc list-inside text-gray-700">
                        ${info.flights.map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }

        function renderAccommodations(accommodations) {
            const container = document.getElementById('accommodation-container');
            if (!container) return;
            container.innerHTML = accommodations.map(acc => `
                <div class="mb-4">
                    <h4 class="font-semibold text-lg text-gray-800">${acc.name}</h4>
                    <p class="text-sm text-gray-600">${acc.dates} | ${acc.address}</p>
                    <p class="text-sm text-gray-600">üìç ${acc.station}</p>
                    <p class="text-sm text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤: ${acc.priceTHB.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó</p>
                    <a href="${acc.mapLink}" target="_blank" class="text-blue-600 hover:underline text-sm">‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Google Maps</a>
                </div>
            `).join('');
        }

        // (renderDailyItinerary remains largely the same)
        function renderDailyItinerary(itinerary, poiCatalog) {
            const container = document.getElementById('daily-itinerary-container');
            if (!container) return;
            
            // We will use a document fragment or simple innerHTML replacement logic
            // NOTE: Re-rendering clears open state of details unless we preserve it. 
            // For simplicity in this version, we won't persist 'open' details across edits, 
            // but 'toggleDayHeaderEdit' handles its own state.

            // To preserve open state of days, we can check DOM.
            const openStates = {};
            const detailsElements = container.querySelectorAll('details');
            detailsElements.forEach((el, idx) => {
                openStates[idx] = el.hasAttribute('open');
            });
            
            container.innerHTML = itinerary.map((dayItem, index) => {
                const timelineHtml = (dayItem.items || []).sort((a, b) => a.time.localeCompare(b.time)).map(item => {
                    const createdByHtml = item.createdBy 
                        ? `<p class="text-xs text-gray-400 italic mt-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ${item.createdBy.split(' ')[0]}</p>` 
                        : '';

                    return `
                    <div class="timeline-item pb-4">
                        <div class="timeline-dot"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-semibold text-gray-800">${item.time}</span>
                                <p class="text-gray-700">${item.text.replace(/\n/g, '<br>')}</p>
                                ${createdByHtml} 
                            </div>
                            <div class="flex-shrink-0 ml-2">
                                <button onclick="window.app.editDailyItem(${index}, '${item.id}')"
                                    class="text-blue-500 hover:text-blue-700 text-sm font-medium">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button onclick="window.app.removeDailyItem(${index}, '${item.id}')" 
                                    class="text-red-500 hover:text-red-700 text-sm font-medium ml-2">‡∏•‡∏ö</button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                const poiOptions = poiCatalog.map(poi => 
                    `<option value="${poi.id}">${poi.name}</option>`
                ).join('');

                // Restore open state or default to open for first day
                const isOpen = openStates[index] !== undefined ? openStates[index] : (index === 0);

                return `
                <details ${isOpen ? 'open' : ''} class="mb-2 bg-white shadow-sm rounded-lg overflow-hidden">
                    <summary class="font-semibold p-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center gap-2">
                        
                        <!-- Display Mode -->
                        <div id="day-header-display-${index}" class="flex justify-between items-center flex-grow">
                            <span class="font-semibold text-lg text-gray-800">${dayItem.day}</span>
                            <button onclick="window.app.toggleDayHeaderEdit(${index}, event, true)" 
                                    class="ml-2 p-2 rounded-full hover:bg-gray-200 flex-shrink-0">
                                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                        </div>

                        <!-- Edit Mode (Hidden by default) -->
                        <div id="day-header-edit-${index}" class="hidden flex justify-between items-center flex-grow gap-2">
                            <input type="text" id="day-header-input-${index}" value="${dayItem.day}" 
                                   class="font-semibold text-lg p-2 border border-gray-300 rounded-md flex-grow focus:border-blue-500 focus:ring-blue-500">
                            <button onclick="window.app.updateDayHeader(${index})" 
                                    class="ml-2 px-3 py-1 bg-green-500 text-white text-sm rounded-md hover:bg-green-600 flex-shrink-0">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            <button onclick="window.app.toggleDayHeaderEdit(${index}, event, false)" 
                                    class="px-3 py-1 bg-gray-400 text-white text-sm rounded-md hover:bg-gray-500 flex-shrink-0">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>

                    </summary>
                    <div class="p-4 border-t border-gray-200">
                        <div class="mb-4">
                            ${timelineHtml || '<p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>'}
                        </div>
                        
                        <div class="mt-4 pt-4 border-t">
                            <h4 class="font-semibold mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                <input type="time" id="item-time-${index}" class="p-2 border bo